name: Sync Branch on Label

on:
  pull_request:
    types: [labeled]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Git credentials
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch and PR
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          LABEL="${{ github.event.label.name }}"
          PR="${{ github.event.pull_request.number }}"
          SOURCE="${{ github.event.pull_request.head.ref }}"

          # only run on label 'dev' or 'stage'
          if [[ "$LABEL" == "dev" || "$LABEL" == "stage" ]]; then
            TARGET="$LABEL"

            SYNC_BRANCH="sync/${PR}-${TARGET}"

            echo "Creating sync PR from $SOURCE → $TARGET"

            # create new branch
            git checkout "$SOURCE"
            git pull origin "$SOURCE"
            git checkout -b "$SYNC_BRANCH"

            # push sync branch
            git push -f origin "$SYNC_BRANCH"

            # create PR using gh cli
            echo "Creating Pull Request..."
            gh pr create \
              --base "$TARGET" \
              --head "$SYNC_BRANCH" \
              --title "Sync: PR #$PR → $TARGET" \
              --body "Auto sync created for PR #$PR" \
              --label "sync" || echo "PR already exists"
          else
            echo "Label not dev or stage, skipping."
          fi
