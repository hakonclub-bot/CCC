name: Sync PR

on:
  pull_request:
    types: [labeled, synchronize]

jobs:
  sync-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Authenticate GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token
          gh auth status

      - name: Debug Info
        run: |
          echo "Event: ${{ github.event.action }}"
          echo "PR #: ${{ github.event.pull_request.number }}"
          echo "Head: ${{ github.event.pull_request.head.ref }}"
          echo "Repo: ${{ github.repository }}"

      #############################################
      # Detect target branch from label
      #############################################

      - name: Detect label target
        id: detect
        if: github.event.action == 'labeled'
        run: |
          LABEL="${{ github.event.label.name }}"
          if [ "$LABEL" = "dev" ]; then
            echo "target=dev" >> $GITHUB_OUTPUT
          elif [ "$LABEL" = "stage" ]; then
            echo "target=stage" >> $GITHUB_OUTPUT
          else
            echo "target=" >> $GITHUB_OUTPUT
          fi
          echo "Detected label: $LABEL"

      - name: Stop if label is not dev/stage
        if: github.event.action == 'labeled' && steps.detect.outputs.target == ''
        run: |
          echo "Label is not dev or stage â†’ skipping"
          exit 0

      #############################################
      # CREATE or UPDATE sync branch + PR
      #############################################

      - name: Create or Update Sync Branch & PR
        id: sync
        if: github.event.action == 'labeled' && steps.detect.outputs.target != ''
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -e

          FEATURE="${{ github.event.pull_request.head.ref }}"
          TARGET="${{ steps.detect.outputs.target }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          SYNC_BRANCH="sync/${PR_NUM}-${TARGET}"

          echo "Feature: $FEATURE"
          echo "Target: $TARGET"
          echo "Sync Branch: $SYNC_BRANCH"

          git fetch origin

          # Always recreate sync branch from feature
          git checkout -B "$SYNC_BRANCH" "origin/$FEATURE"
          git push -f "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}" "$SYNC_BRANCH"

          echo "Sync branch updated: $SYNC_BRANCH"

          # Try create PR
          CREATE=$(gh pr create \
            --base "$TARGET" \
            --head "$SYNC_BRANCH" \
            --title "Sync: $FEATURE â†’ $TARGET" \
            --body "Auto sync PR for #$PR_NUM" \
            --label sync \
            --json number,url 2>/dev/null || true)

          # If PR already exists, fetch it
          if [ -z "$CREATE" ]; then
            CREATE=$(gh pr list --head "$SYNC_BRANCH" --base "$TARGET" --state open --json number,url --limit 1)
          fi

          echo "PR JSON: $CREATE"

          PR_URL=$(echo "$CREATE" | jq -r '.[0].url // .url')
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Comment back to original PR
        if: github.event.action == 'labeled' && steps.sync.outputs.pr_url != ''
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          gh pr comment "${{ github.event.pull_request.number }}" \
            --body "ðŸ”„ **Sync PR created**  
Target: **${{ steps.detect.outputs.target }}**  
Link: ${{ steps.sync.outputs.pr_url }}"

      #############################################
      # Auto-update sync PR when feature PR updates
      #############################################

      - name: Auto-update sync branches on synchronize
        if: github.event.action == 'synchronize'
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          PR="${{ github.event.pull_request.number }}"
          FEATURE="${{ github.event.pull_request.head.ref }}"

          for TARGET in dev stage; do
            SYNC_BRANCH="sync/${PR}-${TARGET}"

            if git ls-remote --exit-code origin "$SYNC_BRANCH" > /dev/null 2>&1; then
              echo "Updating $SYNC_BRANCH"
              git fetch origin
              git push -f "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}" \
                "refs/remotes/origin/$FEATURE:refs/heads/$SYNC_BRANCH"
            fi
          done
